
---
title: "Merging Tables for pPCA"
output: html_notebook
---

# Load required libraries
```{r}
library(tidyverse)
```

# Load datasets
```{r}
combine_reported <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/trait_data_reported.csv")
combine_imputed <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/trait_data_imputed.csv")
Elton_full <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/MamFuncDat.csv")
MammalDiet_2015 <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/MammalDIET_v1.0.xlsx - MammalDIET_v1.0.txt.csv")
MammalDiet_2018 <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/mam12119-sup-0001-appendixs1.csv", skip = 2, header = TRUE)
Myhrvold <- read.csv("C:/Users/umder/Desktop/meyerlab/Data/Amniote_Database_Aug_2015.csv")

```

# Preprocessing MammalDiet Data
```{r}
# Create scientific_name in MammalDiet_2015
MammalDiet_2015 <- MammalDiet_2015 %>%
  mutate(scientific_name = paste(Genus, Species))

# Remove unnecessary columns and convert relevant columns to factors in MammalDiet_2015 and MammalDiet_2018
MammalDiet_2015 <- MammalDiet_2015 %>%
  select(-c(TaxonID, DataSource, TaxonomicNote, FillCode)) %>%
  mutate(across(c(Order, Family, Genus, Species, TrophicLevel), as.factor))

MammalDiet_2018 <- MammalDiet_2018 %>%
  select(-starts_with("X"), -Bibliography) %>%
  mutate(across(c(Order, Family, Genus, Species, TrophicLevel), as.factor))

# Merge MammalDiet_2015 and MammalDiet_2018 on scientific_name
MammalDiet_Combined <- MammalDiet_2015 %>%
  full_join(MammalDiet_2018, by = c("scientific_name" = "Binomial"))

# Coalesce matching columns and drop .x and .y suffixes
common_cols <- names(MammalDiet_Combined)[grepl("\\.x$|\\.y$", names(MammalDiet_Combined))]

for (col in unique(gsub("\\.x$|\\.y$", "", common_cols))) {
  MammalDiet_Combined[[paste0(col, ".x")]] <- as.character(MammalDiet_Combined[[paste0(col, ".x")]])
  MammalDiet_Combined[[paste0(col, ".y")]] <- as.character(MammalDiet_Combined[[paste0(col, ".y")]])
  MammalDiet_Combined[[col]] <- coalesce(MammalDiet_Combined[[paste0(col, ".y")]], MammalDiet_Combined[[paste0(col, ".x")]])
}

# Drop .x and .y columns and reconvert to factors
MammalDiet_Combined <- MammalDiet_Combined %>%
  select(-ends_with(".x"), -ends_with(".y")) %>%
  mutate(across(c(Order, Family, Genus, Species, TrophicLevel), as.factor))
```

# Merge with Other Datasets
```{r}
# Select informative columns from combine_reported and merge with MammalDiet_Combined
iucn_informative_cols <- combine_reported %>%
  select(-c(order, family, genus, species, phylacine_binomial))

MammalDiet_Combined <- MammalDiet_Combined %>%
  left_join(iucn_informative_cols, by = c("scientific_name" = "iucn2020_binomial"))

# Select informative columns from Elton_full and merge
elton_informative_cols <- Elton_full %>%
  select(-c(MSWFamilyLatin))

MammalDiet_Combined <- MammalDiet_Combined %>%
  left_join(elton_informative_cols, by = c("scientific_name" = "Scientific"))

# Combine 'genus' and 'species' into 'scientific_name' in Myhrvold and merge
Myhrvold <- Myhrvold %>%
  mutate(scientific_name = paste(genus, species))

myhrvold_informative_cols <- Myhrvold %>%
  select(-c(genus, species, class, order, family))

MammalDiet_Combined <- MammalDiet_Combined %>%
  left_join(myhrvold_informative_cols, by = "scientific_name")

# View final dataframe
print(MammalDiet_Combined)
str(MammalDiet_Combined)
```

# Convert Text Files to CSV
```{r}
setwd("./Data/txtToConvert")
filelist = list.files(pattern = ".txt")

for (input in filelist) {
  output <- paste0(gsub("\\.txt$", "", input), ".csv")
  print(paste("Processing the file:", input))
  data <- read.delim(input, header = TRUE)
  write.table(data, file = output, sep = ",", col.names = TRUE, row.names = FALSE)
}
```

# Analyze Missing Data
```{r}
missing_threshold <- 0.3

# Check missing data proportions
missing_proportion_columns <- colMeans(is.na(master))
combine_reported_clean <- master[, missing_proportion_columns <= missing_threshold]

# View structure of datasets
str(master)
str(combine_reported)
```

PRELIM EDA BELOW, LOCK IN THIS WEEK AND FILTER DOWN (actually ask for help)
```{r}
# Descriptive statistics for selected biological traits
MammalDiet_summary <- MammalDiet_Combined %>%
  summarise(
    Mass_Mean = mean(adult_mass_g, na.rm = TRUE),
    Mass_SD = sd(adult_mass_g, na.rm = TRUE),
    Length_Mean = mean(adult_body_length_mm, na.rm = TRUE),
    Length_SD = sd(adult_body_length_mm, na.rm = TRUE),
    Altitude_Mean = mean(altitude_breadth_m, na.rm = TRUE),
    Altitude_SD = sd(altitude_breadth_m, na.rm = TRUE)
  )
MammalDiet_summary

```
PRELIM MASS DIST
```{r}
mass_dist <- ggplot(MammalDiet_Combined, aes(x = adult_mass_g)) +
  geom_histogram(binwidth = 50, fill = 'green', color = 'black') +
  labs(title = "Adult Mass Distribution", x = "Adult Mass (g)", y = "Frequency") +
  theme_classic() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 16)
  )
ggsave(filename = "Adult_Mass.png", plot = mass_dist, width = 10, height = 8, dpi = 300)

```

PRELIM PLANT DIST
```{r}
diet_dist <- ggplot(MammalDiet_Combined, aes(x = Diet.PlantO)) +
  geom_bar(fill = 'purple', color = 'black') +
  labs(title = "Plant Diet Distribution", x = "Plant Diet Percentage", y = "Count") +
  theme_classic() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    plot.title = element_text(size = 16)
  )
ggsave(filename = "Diet_PlantO.png", plot = diet_dist, width = 10, height = 8, dpi = 300)

```

EDA
```{r}
# List of variables to plot
variables_to_plot <- c("TrophicLevel", "adult_mass_g", "altitude_breadth_m", 
                       "Diet.PlantO", "Diet.Inv", "Diet.Fruit", 
                       "habitat_breadth_n", "activity_cycle", 
                       "biogeographical_realm", "social_group_n")

plot_and_save <- function(MammalDiet_Combined, variable_name) {
  # Create a neat title by replacing underscores with spaces
  neat_title <- gsub("_", " ", variable_name)
  
  # Create the plot with labels
  p <- ggplot(MammalDiet_Combined, aes_string(x = variable_name, fill = variable_name)) +
    geom_bar(color = 'black') +
    geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) +
    theme_classic() +
    theme(
      text = element_text(size = 12),
      axis.title = element_text(size = 14),
      plot.title = element_text(size = 16),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10)
    ) +
    labs(title = neat_title, x = neat_title, y = "Count") +
    guides(fill=FALSE) # This removes the legend
  
  # Save the plot as an image file
  ggsave(filename = paste0(variable_name, ".png"), plot = p, width = 10, height = 8, dpi = 300)
  
  # Return the plot object in case it needs to be printed or further modified
  return(p)
}

# Loop through the variable names, plot, save, and print each one
for (variable_name in variables_to_plot) {
  plot <- plot_and_save(MammalDiet_Combined, variable_name)
  print(plot)
}

```

CORRELATION & ANOVA
```{r}
# Identify all numeric variables
numeric_vars <- MammalDiet_Combined %>% 
  select_if(is.numeric)

# Calculate correlations with 'adult_mass_g'
correlations <- sapply(numeric_vars, function(x) cor(x, MammalDiet_Combined$adult_mass_g, 
                                                     use = "complete.obs"))

# View the correlation coefficients
print(correlations)

# Select only categorical variables
cat_vars <- MammalDiet_Combined %>% select_if(is.factor)

# Loop through each categorical variable and perform ANOVA
anova_results <- lapply(names(cat_vars), function(var) {
  formula <- as.formula(paste("adult_mass_g ~", var))
  anova_test <- aov(formula, data = MammalDiet_Combined)
  return(summary(anova_test))
})

# Name the list elements for easier identification
names(anova_results) <- names(cat_vars)

# Now you can view the ANOVA results for each categorical variable
anova_results

```

